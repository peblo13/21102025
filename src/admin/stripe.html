<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stripe • Ustawienia • eCVjob.pl</title>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b0b0b; color:#e8ffe8; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    .wrap { max-width: 840px; margin: 6vh auto; padding: 24px; border:1px solid #0a0; border-radius:16px; background:rgba(0,0,0,0.6); }
    h1 { color:#00ff66; margin-top:0; }
    .row { margin: 12px 0; }
    input[type="password"], input[type="text"] { width:100%; max-width: 720px; padding:10px 12px; border-radius:10px; border:1px solid #0a0; background:#0a0a0a; color:#e6ffe6; }
    button { padding:12px 18px; border-radius:10px; border:1px solid #00ff00; background:#003300; color:#b6ffb6; font-weight:700; cursor:pointer; }
    code { background:#061; padding:2px 6px; border-radius:6px; }
    .ok { color:#7fff7f; }
    .bad { color:#ff9f9f; }
    .box { border:1px dashed #085; border-radius:12px; padding:12px; background:rgba(0,32,0,0.35); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Stripe • Ustawienia</h1>
    <p>Ta strona zapisuje klucz <strong>Secret Key</strong> do pliku <code>server/stripe-secret.txt</code>. Dostęp do zapisu jest ograniczony do <code>localhost</code>.</p>

    <div class="row box" id="health">Sprawdzam status…</div>

    <div class="row">
      <label for="secret">Wklej swój klucz Secret (testowy lub live):</label>
      <input id="secret" type="password" placeholder="sk_test_… lub sk_live_…" autocomplete="off" />
    </div>
    <div class="row">
      <button id="save">Zapisz klucz</button>
      <a href="../../src/checkout.html?type=plan&plan=Premium" style="margin-left:12px;" class="btn">Przejdź do testu Checkout</a>
    </div>
  </div>

  <script>
    const healthBox = document.getElementById('health');
    async function loadHealth(){
      try {
        const url = new URL('../../server/health.php', location.href).toString();
        const res = await fetch(url, { cache: 'no-store' });
        const data = await res.json();
        if (data && data.stripeSecretDetected) {
          healthBox.innerHTML = `✅ Sekret wykryty (źródło: <code>${data.source||'-'}</code>, prefiks: <code>${data.prefix||'-'}</code>)`;
          healthBox.className = 'row box ok';
        } else {
          healthBox.innerHTML = `❌ Brak poprawnego sekretu Stripe. Użyj formularza poniżej.`;
          healthBox.className = 'row box bad';
        }
      } catch (e) {
        healthBox.textContent = 'Błąd sprawdzania: ' + (e.message || e);
        healthBox.className = 'row box bad';
      }
    }

    document.getElementById('save').addEventListener('click', async () => {
      const v = (document.getElementById('secret').value || '').trim();
      if (!v) { alert('Wklej sekret.'); return; }
      if (!/^sk_[a-zA-Z0-9]{5,}/.test(v)) {
        if (!confirm('Klucz nie wygląda na prawidłowy (sk_…). Zapisać mimo to?')) return;
      }
      try {
        const url = new URL('../../server/save-stripe-secret.php', location.href).toString();
        const res = await fetch(url, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ secret: v })
        });
        const data = await res.json().catch(() => null);
        if (!res.ok) throw new Error((data && data.error) || ('HTTP ' + res.status));
        alert('Zapisano.');
        document.getElementById('secret').value = '';
        loadHealth();
      } catch (e) {
        alert('Błąd zapisu: ' + (e.message || e));
      }
    });

    loadHealth();
  </script>
</body>
</html>
